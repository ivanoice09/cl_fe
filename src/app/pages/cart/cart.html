<div class="cart-container">

  <!--  STATO DI CARICAMENTO -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Caricamento...</span>
      </div>
      <p class="mt-3">Caricamento carrello...</p>
    </div>
  }

  <!-- STATO DI ERRORE -->
  @if (errorMessage && !isLoading) {
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      {{ errorMessage }}
    </div>
  }

  <!-- CARRELLO VUOTO -->
  @if (!isLoading && cart && cart.items.length === 0) {
    <div class="empty-cart">
      <i class="bi bi-cart-x display-1 text-muted"></i>
      <h2 class="mt-4">Il tuo carrello è vuoto</h2>
      <p class="text-muted">Non hai ancora aggiunto prodotti al carrello</p>
      <button class="btn btn-primary btn-lg mt-3" (click)="continueShopping()">
        <i class="bi bi-arrow-left me-2"></i>
        Continua lo Shopping
      </button>
    </div>
  }

  <!-- CONTENUTO CARELLO (Prodotti + Riepilogo) -->
  @if (!isLoading && cart && cart.items.length > 0) {
    <div class="cart-content">
      
      <div class="cart-header">
        <h1>
          <i class="bi bi-cart-fill me-3"></i>
          Il Tuo Carrello
        </h1>
        <p class="text-muted">
          {{ cart.items.length }} {{ cart.items.length === 1 ? 'prodotto' : 'prodotti' }} 
          ({{ getTotalItems() }} items)
        </p>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="cart-items">
            
            @for (item of cart.items; track item.productId) {
              <div class="cart-item">
                <div class="row align-items-center">
                  
                  <!-- Immagine -->
                  <div class="col-md-2 col-3">
                    <a [routerLink]="['/product', item.productId]" class="d-block">
                      <img
                        [src]="'data:image/gif;base64,' + item.thumbnailPhotoFileName"
                        [alt]="item.productName"
                        class="img-fluid rounded"
                      />
                    </a>
                  </div>

                  <!-- Dettagli -->
                  <div class="col-md-4 col-9">
                    <h5 class="mb-1">
                      <a [routerLink]="['/product', item.productId]" class="text-decoration-none text-dark hover-primary">
                        {{ item.productName }}
                      </a>
                    </h5>
                    <p class="text-primary fw-bold mb-0">{{ item.price | number : '1.2-2' }} €</p>
                  </div>

                  <!-- Quantità -->
                  <div class="col-md-3 col-6">
                    <div class="quantity-controls">
                      <button
                        class="btn btn-outline-secondary btn-sm"
                        (click)="decrementQuantity(item)"
                        [disabled]="item.quantity <= 1"
                      >
                        <i class="bi bi-dash"></i>
                      </button>

                      <input
                        type="number"
                        class="form-control form-control-sm text-center mx-2"
                        [value]="item.quantity"
                        (change)="updateQuantity(item, $any($event.target).value)"
                        min="1"
                        style="width: 60px"
                      />

                      <button
                        class="btn btn-outline-secondary btn-sm"
                        (click)="incrementQuantity(item)"
                      >
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Subtotale e Rimozione -->
                  <div class="col-md-2 col-4 text-end">
                    <p class="fw-bold mb-2">{{ getItemTotal(item) | number : '1.2-2' }} €</p>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="removeItem(item)"
                      title="Rimuovi"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            } 

          </div>

          <!-- Bottoni Azione -->
          <div class="cart-actions mt-4">
            <button class="btn btn-outline-secondary" (click)="continueShopping()">
              <i class="bi bi-arrow-left me-2"></i>
              Continua lo Shopping
            </button>

            <button class="btn btn-outline-danger" (click)="clearCart()">
              <i class="bi bi-trash me-2"></i>
              Svuota Carrello
            </button>
          </div>
        </div>

        <!-- Riepilogo Laterale -->
        <div class="col-lg-4">
          <div class="cart-summary">
            <h4 class="mb-4">Riepilogo Ordine</h4>

            <div class="summary-row">
              <span>Subtotale ({{ getTotalItems() }} items)</span>
              <span class="fw-bold">{{ getTotalAmount() | number : '1.2-2' }} €</span>
            </div>

            <div class="summary-row">
              <span>Spedizione</span>
              <span class="text-success">Gratis</span>
            </div>

            <hr />

            <div class="summary-row total">
              <span class="h5">Totale</span>
              <span class="h4 text-primary fw-bold">
                {{ getTotalAmount() | number : '1.2-2' }} €
              </span>
            </div>

            <button class="btn btn-primary btn-lg w-100 mt-4" (click)="proceedToCheckout()">
              Procedi al Checkout
              <i class="bi bi-arrow-right ms-2"></i>
            </button>

            <div class="mt-3 text-center">
              <small class="text-muted">
                <i class="bi bi-shield-check me-1"></i>
                Pagamento sicuro
              </small>
            </div>
          </div>
        </div>
      
      </div> 
    </div> 
  } 

</div>
